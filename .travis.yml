language: c

sudo: false

matrix:
  include:
  - os: linux
    compiler: gcc
    env:
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
  - os: linux
    compiler: clang
    env:
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - clang
  - os: linux
    compiler: gcc
    env: STATIC=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
  - os: linux
    compiler: clang
    env: STATIC=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - clang
  - os: osx
    compiler: clang
    env:
    before_install:
      - brew install gdb
  - os: osx
    compiler: clang
    env: STATIC=1
    before_install:
      - brew install gdb
  - os: osx
    compiler: clang
    env: NOTHREADS=1
    before_install:
      - brew install gdb
  - os: osx
    compiler: clang
    env: STATIC=1 NOTHREADS=1
    before_install:
      - brew install gdb
  - os: linux
    compiler: gcc
    env: DIST=1
    dist: trusty
    sudo: true
    before_install:
      - sudo apt-get -qq update
      - sudo apt-get install -y pandoc
  - os: linux
    compiler: gcc
    env: POLL=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
  - os: linux
    compiler: gcc
    env: NOTHREADS=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
  - os: linux
    compiler: gcc
    env: CENSUS=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
  - os: linux
    compiler: gcc
    env: VALGRIND=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
          - valgrind
  - os: linux
    compiler: gcc
    env: STATIC=1 VALGRIND=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
          - valgrind
  - os: linux
    compiler: gcc
    env: NOTHREADS=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
  - os: linux
    compiler: gcc
    env: VALGRIND=1 NOTHREADS=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
          - valgrind
  - os: linux
    compiler: gcc
    env: POLL=1 NOTHREADS=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
  - os: linux
    compiler: gcc
    env: STATIC=1 NOTHREADS=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
  - os: linux
    compiler: gcc
    env: ARCH_FALLBACK=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
  - os: linux
    compiler: clang
    env: ARCH_FALLBACK=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - clang
  - os: linux
    compiler: gcc
    env: THREAD_FALLBACK=1
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gdb
          - gcc-4.9
  - os: osx
    compiler: clang
    env: THREAD_FALLBACK=1
    before_install:
      - brew install gdb


branches:
  except:
    - gh-pages

install:
  - ./autogen.sh
  - ./configure ${STATIC+--disable-shared} ${DEBUG+--enable-debug} ${VALGRIND+--enable-valgrind} ${CENSUS+--enable-census} ${NOTHREADS+--disable-threads} CFLAGS="-O3 ${POLL+-DDILL_POLL} ${ARCH_FALLBACK+-DDILL_ARCH_FALLBACK} ${THREAD_FALLBACK+-DDILL_THREAD_FALLBACK}"
  - make V=1 ${DIST+dist}

script:
  - ulimit -c unlimited
  - test ${DIST+x} || make check

after_failure:
  - for f in tests/*.log; do echo; echo "${f}:"; cat $f; done;
  - cat test-suite.log
  - id
  - ulimit -c
  - sysctl kernel.core_pattern
  - ls /tmp
  - find / -name '*core*'
  - for core in $(ls /tmp/core* 2> /dev/null); do echo "found coredump $core"; bin=tests/.libs/$(file $core | awk -F \' '{print $2}'); if [ -f $bin ]; then echo "coredump generated by $bin"; gdb -c $core -batch -ex "set pagination 0" -ex "thread apply all bt" $bin; fi; done

notifications:
  email: false
