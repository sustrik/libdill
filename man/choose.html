<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>libdill</title>
  <link rel="stylesheet" type="text/css" href="http://libdill.org/main.css">
</head>
<body>

<h1>libdill: Structured Concurrency for C</h1>

<ul id='toplist'>
<li><a href="index.html">Home</a></li>
<li><a href="download.html">Download</a></li>
<li><a href="documentation.html">Documentation</a></li>
<li><a href="tutorial.html">Tutorials</a></li>
</ul>
<h1 id="name">NAME</h1>
<p>choose - perform one of multiple channel operations</p>
<h1 id="synopsis">SYNOPSIS</h1>
<pre class="sourceCode c"><code class="sourceCode c"><span class="ot">#define CHSEND 1</span>
<span class="ot">#define CHRECV 2</span>

<span class="kw">struct</span> chclause {
    <span class="dt">int</span> op;
    <span class="dt">int</span> ch;
    <span class="dt">void</span> *val;
    size_t len;
};</code></pre>
<p><strong>#include &lt;libdill.h&gt;</strong></p>
<p><strong>int choose(struct chclause </strong>*<em>clauses</em><strong>, int</strong> <em>nclauses</em><strong>, int64_t</strong> <em>deadline</em><strong>);</strong></p>
<h1 id="description">DESCRIPTION</h1>
<p>Accepts a list of channel operations. Performs one that can be done first. If multiple operations can be done immediately, the one that comes earlier in the array is executed.</p>
<p><em>op</em> is a code denoting the operation to be done, and it's either <strong>CHSEND</strong> or <strong>CHRECV</strong>. <em>ch</em> is a channel handle. <em>val</em> is a pointer to a buffer to send data from or receive data to. <em>len</em> is the byte size of the buffer.</p>
<p><em>deadline</em> is a point in time when the operation should time out. Use the <strong>now</strong> function to get the current point in time. 0 means immediate timeout, i.e., perform the operation if possible or return without blocking if not. -1 means no deadline, i.e., the call will block forever if the operation cannot be performed.</p>
<p>If the deadline expires before any operation can be performed, the function will fail with an <strong>ETIMEDOUT</strong> error.</p>
<h1 id="return-value">RETURN VALUE</h1>
<p>Returns -1 if an error occurred. Otherwise, it returns the index of the clause that caused the function to exit. Even in the latter case, <em>errno</em> may be set to indicate failure.</p>
<h1 id="errors">ERRORS</h1>
<p>If the function returns -1, <em>errno</em> is set to one of the following values:</p>
<ul>
<li><strong>ECANCELED</strong>: Current coroutine is being shut down.<br /></li>
<li><strong>ETIMEDOUT</strong>: Deadline has expired.</li>
</ul>
<p>If the function returns an index, it set <em>errno</em> to one of the following values:</p>
<ul>
<li>0: Operation completed successfully.<br /></li>
<li><strong>EBADF</strong>: Invalid handle.<br /></li>
<li><strong>EINVAL</strong>: Invalid parameter.<br /></li>
<li><strong>ENOTSUP</strong>: Operation not supported. Presumably, the handle isn't a channel.<br /></li>
<li><strong>EPIPE</strong>: Channel has been closed with <strong>hdone</strong>.</li>
</ul>
<h1 id="example">EXAMPLE</h1>
<pre class="sourceCode c"><code class="sourceCode c"><span class="dt">int</span> val1 = <span class="dv">0</span>;
<span class="dt">int</span> val2;
<span class="kw">struct</span> chclause clauses[] = {
    {CHSEND, ch, &amp;val1, <span class="kw">sizeof</span>(val1)},
    {CHRECV, ch, &amp;val2, <span class="kw">sizeof</span>(val2)}
};
<span class="dt">int</span> result = choose(clauses, <span class="dv">2</span>, now() + <span class="dv">1000</span>);
<span class="kw">if</span>(result == -<span class="dv">1</span>) {
    perror(<span class="st">&quot;Choose failed&quot;</span>);
    exit(<span class="dv">1</span>);
}
<span class="kw">if</span>(result == <span class="dv">0</span>) {
    printf(<span class="st">&quot;Value %d sent.</span><span class="ch">\n</span><span class="st">&quot;</span>, val1);
}
<span class="kw">if</span>(result == <span class="dv">1</span>) {
    printf(<span class="st">&quot;Value %d received.</span><span class="ch">\n</span><span class="st">&quot;</span>, val2);
}</code></pre>
</body>
